# ----------------------------------------------------------------
# 1. Ignition Generation
# ----------------------------------------------------------------
- name: Create Ignition Configs
  command: "openshift-install create ignition-configs --dir {{ install_dir }}"

# ----------------------------------------------------------------
# 2. Extract Data (InfraID, AMI, CA Certs)
# ----------------------------------------------------------------
- name: Read metadata.json for InfraID
  slurp:
    src: "{{ install_dir }}/metadata.json"
  register: metadata_file

- name: Set InfraID Fact
  set_fact:
    infra_id: "{{ (metadata_file.content | b64decode | from_json).infraID }}"

- name: Fetch CoreOS AMI ID for Region
  shell: |
    ./openshift-install coreos print-stream-json | \
    jq -r '.architectures.x86_64.images.aws.regions["{{ aws_region }}"].image'
  register: ami_fetch

- name: Set AMI Fact
  set_fact:
    rhcos_ami: "{{ ami_fetch.stdout }}"

- name: Read master.ign to extract CA Certificate
  slurp:
    src: "{{ install_dir }}/master.ign"
  register: master_ign_file

- name: Extract CA Bundle from Ignition
  set_fact:
    # Extracts the "data:text/plain..." string from the JSON structure
    ca_bundle: "{{ (master_ign_file.content | b64decode | from_json).ignition.security.tls.certificateAuthorities[0].source }}"

# ----------------------------------------------------------------
# 3. S3 Bootstrap Upload
# ----------------------------------------------------------------
- name: Generate Stable S3 Bucket Name
  set_fact:
    # We construct the name here so it doesn't change on every access
    stable_s3_bucket: "{{ cluster_name }}-infra-bootstrap-{{ 99999 | random }}"
  run_once: true

- name: Create S3 Bucket (via CLI)
  shell: "aws s3 mb s3://{{ stable_s3_bucket }} --region {{ aws_region }}"
  register: s3_create
  failed_when:
    - s3_create.rc != 0
    - '"BucketAlready" not in s3_create.stderr'
  become: false

- name: Upload Bootstrap Ignition (via CLI)
  shell: "aws s3 cp {{ install_dir }}/bootstrap.ign s3://{{ stable_s3_bucket }}/bootstrap.ign"
  become: false

- name: Generate Presigned URL (via CLI)
  shell: "aws s3 presign s3://{{ stable_s3_bucket }}/bootstrap.ign --expires-in 3600 --region {{ aws_region }}"
  register: presign_output
  become: false

- name: Set Bootstrap URL Fact
  set_fact:
    bootstrap_url:
      url: "{{ presign_output.stdout | trim }}"

# ----------------------------------------------------------------
# 4. Stack 1: Network (LBs, DNS, Lambdas)
# ----------------------------------------------------------------
- name: "Deploy Network Stack ({{ cft.tpl_net }})"
  amazon.aws.cloudformation:
    stack_name: "{{ cluster_name }}-net-lb"
    state: present
    region: "{{ aws_region }}"
    template_body: "{{ lookup('file', cft.tpl_net) }}"
    template_parameters:
      ClusterName: "{{ cluster_name }}"
      InfrastructureName: "{{ infra_id }}"
      HostedZoneName: "{{ base_domain }}"
      HostedZoneId: "{{ aws.hosted_zone_id }}"
      VpcId: "{{ aws.vpc_id }}"
      PublicSubnets: "{{ aws.public_subnets | join(',') }}"
      PrivateSubnets: "{{ aws.private_subnets | join(',') }}"
  register: net_stack

# ----------------------------------------------------------------
# 5. Stack 2: Security Groups & IAM
# ----------------------------------------------------------------
- name: "Deploy Security Stack ({{ cft.tpl_sg }})"
  amazon.aws.cloudformation:
    stack_name: "{{ cluster_name }}-security"
    state: present
    region: "{{ aws_region }}"
    template_body: "{{ lookup('file', cft.tpl_sg) }}"
    template_parameters:
      InfrastructureName: "{{ infra_id }}"
      VpcId: "{{ aws.vpc_id }}"
      VpcCidr: "{{ install_config.machine_network.cidr }}" # Ensure this matches your actual VPC CIDR
      PrivateSubnets: "{{ aws.private_subnets | join(',') }}"
  register: sec_stack

# ----------------------------------------------------------------
# 6. Stack 3: Bootstrap Node
# ----------------------------------------------------------------
- name: "Deploy Bootstrap Stack ({{ cft.tpl_boot }})"
  amazon.aws.cloudformation:
    stack_name: "{{ cluster_name }}-bootstrap"
    state: present
    region: "{{ aws_region }}"
    template_body: "{{ lookup('file', cft.tpl_boot) }}"
    template_parameters:
      InfrastructureName: "{{ infra_id }}"
      RhcosAmi: "{{ rhcos_ami }}"
      PublicSubnet: "{{ aws.public_subnets[0] }}" # Uses first public subnet
      MasterSecurityGroupId: "{{ sec_stack.stack_outputs.MasterSecurityGroupId }}"
      VpcId: "{{ aws.vpc_id }}"
      BootstrapIgnitionLocation: "{{ bootstrap_url.url }}"
      BootstrapInstanceType: "{{ cft.bootstrap_type }}"
      # Link Lambda ARNs from Network Stack
      RegisterNlbIpTargetsLambdaArn: "{{ net_stack.stack_outputs.RegisterNlbIpTargetsLambda }}"
      ExternalApiTargetGroupArn: "{{ net_stack.stack_outputs.ExternalApiTargetGroupArn }}"
      InternalApiTargetGroupArn: "{{ net_stack.stack_outputs.InternalApiTargetGroupArn }}"
      InternalServiceTargetGroupArn: "{{ net_stack.stack_outputs.InternalServiceTargetGroupArn }}"

- name: Wait for Bootstrap API
  command: "./openshift-install wait-for bootstrap-complete --dir {{ install_dir }} --log-level=info"
  async: 3600
  poll: 60

# ----------------------------------------------------------------
# 7. Stack 4: Control Plane (Masters)
# ----------------------------------------------------------------
- name: "Deploy Control Plane Stack ({{ cft.tpl_cp }})"
  amazon.aws.cloudformation:
    stack_name: "{{ cluster_name }}-cp"
    state: present
    region: "{{ aws_region }}"
    template_body: "{{ lookup('file', cft.tpl_cp) }}"
    template_parameters:
      InfrastructureName: "{{ infra_id }}"
      RhcosAmi: "{{ rhcos_ami }}"
      MasterSecurityGroupId: "{{ sec_stack.stack_outputs.MasterSecurityGroupId }}"
      MasterInstanceProfileName: "{{ sec_stack.stack_outputs.MasterInstanceProfile }}"
      MasterInstanceType: "{{ cft.master_type }}"
      # Assign Subnets individually
      Master0Subnet: "{{ aws.private_subnets[0] }}"
      Master1Subnet: "{{ aws.private_subnets[1] }}"
      Master2Subnet: "{{ aws.private_subnets[2] }}"
      # Link Lambda ARNs
      RegisterNlbIpTargetsLambdaArn: "{{ net_stack.stack_outputs.RegisterNlbIpTargetsLambda }}"
      ExternalApiTargetGroupArn: "{{ net_stack.stack_outputs.ExternalApiTargetGroupArn }}"
      InternalApiTargetGroupArn: "{{ net_stack.stack_outputs.InternalApiTargetGroupArn }}"
      InternalServiceTargetGroupArn: "{{ net_stack.stack_outputs.InternalServiceTargetGroupArn }}"
      # Config Locations
      IgnitionLocation: "https://api-int.{{ cluster_name }}.{{ base_domain }}:22623/config/master"
      CertificateAuthorities: "{{ ca_bundle }}"

# ----------------------------------------------------------------
# 8. Stack 5: Workers
# ----------------------------------------------------------------
- name: "Deploy Worker Stacks ({{ cft.tpl_wk }})"
  amazon.aws.cloudformation:
    stack_name: "{{ cluster_name }}-wk{{ index + 1 }}"
    state: present
    region: "{{ aws_region }}"
    template_body: "{{ lookup('file', cft.tpl_wk) }}"
    template_parameters:
      InfrastructureName: "{{ infra_id }}"
      RhcosAmi: "{{ rhcos_ami }}"
      Subnet: "{{ item }}"
      WorkerSecurityGroupId: "{{ sec_stack.stack_outputs.WorkerSecurityGroupId }}"
      WorkerInstanceProfileName: "{{ sec_stack.stack_outputs.WorkerInstanceProfile }}"
      WorkerInstanceType: "{{ cft.worker_type }}"
      IgnitionLocation: "https://api-int.{{ cluster_name }}.{{ base_domain }}:22623/config/worker"
      CertificateAuthorities: "{{ ca_bundle }}"
  loop: "{{ aws.private_subnets }}"
  loop_control:
    index_var: index

# ----------------------------------------------------------------
# 9. CSR Approver Loop
# ----------------------------------------------------------------
- name: Auto-Approve CSRs (Run for 15 mins)
  shell: |
    export KUBECONFIG={{ install_dir }}/auth/kubeconfig
    oc get csr -o go-template='{{ '{{' }}range .items{{ '}}' }}{{ '{{' }}if not .status{{ '}}' }}{{ '{{' }}.metadata.name{{ '}}' }}{{ '{{' }}"\n"{{ '}}' }}{{ '{{' }}end{{ '}}' }}{{ '{{' }}end{{ '}}' }}' | xargs --no-run-if-empty oc adm certificate approve
  register: csr_result
  until: csr_result.rc == 0
  retries: 30  # 30 * 30s = 15 mins
  delay: 30
  ignore_errors: yes

# ----------------------------------------------------------------
# 10. Cleanup & Finalize
# ----------------------------------------------------------------
- name: Remove Bootstrap Stack
  amazon.aws.cloudformation:
    stack_name: "{{ cluster_name }}-bootstrap"
    state: absent
    region: "{{ aws_region }}"

- name: Remove Bootstrap S3 Bucket
  amazon.aws.s3_bucket:
    name: "{{ stable_s3_bucket }}"
    state: absent
    force: yes

- name: Wait for Install Complete
  command: "./openshift-install wait-for install-complete --dir {{ install_dir }}"
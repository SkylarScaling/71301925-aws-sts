---
# Play 1: Provision the EC2 Host
- name: PROVISION EC2 INSTALLER HOST
  hosts: localhost
  connection: local
  gather_facts: false

  roles:
    - provision_ec2_installer

# Play 2: Configure the newly created host
- name: CONFIGURE NEW EC2 INSTALLER HOST
  hosts: newly_created_ec2 # Target the dynamic group created by the first role
  gather_facts: false

  pre_tasks:
    - name: Aggregate Subnet IDs for OpenShift Install Config
      set_fact:
        openshift_aws_subnets: "{{ aws.public_subnets + aws.private_subnets }}"

  roles:
    - configure_openshift_installer

# Play 3: Provision the OpenShift Cluster
- name: PROVISION OPENSHIFT CLUSTER
  hosts: newly_created_ec2 # Target the dynamic group created by the first role
  gather_facts: false

  # =================================================================
  # PRE-TASKS: Install Python/Boto3 Dependencies
  # =================================================================
  pre_tasks:
    - name: Bootstrap Python3 and Pip (Detect OS automatically)
      raw: |
        if command -v yum >/dev/null 2>&1; then
          sudo yum install -y python3-pip
        elif command -v apt-get >/dev/null 2>&1; then
          sudo apt-get update && sudo apt-get install -y python3-pip
        else
          echo "No supported package manager found." >&2
          exit 1
        fi
      changed_when: false

    - name: Install AWS SDK (boto3) using the newly installed Pip
      pip:
        name:
          - boto3
          - botocore
        state: present
        executable: pip3

  roles:
#    - aws_provision_cluster_ipi
    - aws_provision_cluster_cft